{% extends 'base.html' %} 
{% block content %} 
  {% load humanize static %}
  {% load ex_functions %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>


  function allowOnlyNumbers(event) {

   
    // Allow: Backspace, Tab, Arrow keys, Delete
    if (
        event.key === "Backspace" || 
        event.key === "Tab" || 
        event.key === "ArrowLeft" || 
        event.key === "ArrowRight" || 
        event.key === "Delete"
    ) {
        return true; // Allow default behavior
    }

    // Allow only numbers (0-9)
    if (!/^\d$/.test(event.key)) {
        event.preventDefault(); // Block other characters
        return false; // Prevent default behavior
    }





  setTimeout(() => {
   const it = document.getElementById("tis_quantity").value;
    if (it.charAt(0) == "0") {
      let result = removeFirstCharacter(it);
      document.getElementById("tis_quantity").value = result 
     // return it.slice(0); // Removes the first character
    }

  }, 20);


  setTimeout(() => {
    getComposetaion()
   }, 100);

   setTimeout(() => {
    Caculate()
   }, 200);

  

}
function removeFirstCharacter(str) {
  return str.substring(1);
}

  function handleSelectChange(selectElement) {
    const selectedValue = selectElement.value;


    let result = selectElement.value.replace(/[^a-zA-Z0-9 ]/g, ""); // ลบตัวพิเศษ ยกเว้นช่องว่าง
 document.getElementById("teacher_id").value = result;

 setTimeout(() => {
  getComposetaion()
 }, 50);

 setTimeout(() => {
  Caculate()
 }, 200);
  }

  function handleSelectChangePy(selectElement) {
    const selectedValue = selectElement.value;
 document.getElementById("pi").value = selectedValue;

 setTimeout(() => {
  getComposetaion()
 }, 50);

 setTimeout(() => {
  Caculate()
 }, 200);
  }
  

  function Save() {

   const checkUnit = document.getElementById("tis_quantity").value  ////Unit ที่เลือก
   const count_hour_wi = document.getElementById("count_hour_wi").value ////ชั่วโมงที่เลือกไปแล้ว ของ วิทยากร กับ ครูฝึก
   const count_hour_pi = document.getElementById("count_hour_pi").value ////ชั่วโมงที่เลือกไปแล้ว ของ ผู้ช่วย
   const pi = document.getElementById("pi").value
   const hour = document.getElementById("ev_hour").value  ////จำนวนชั่วโมงที่ คอรสระบุ

   
   let te = document.getElementById("teacher_id").value
   if(te == ""){
    Swal.fire({
      title: 'กรุณาเลือกรายชื่อครู - วิทยากร!',
      text: 'กรุณาเลือกรายชื่อ',
      icon: 'error',
      confirmButtonText: 'OK'
    });

    return false
   }

   if(pi == 3){
    let ch = CheckHour(count_hour_pi,checkUnit,hour);
    if(ch == true){
      return true;
    }
    Swal.fire({
      title: 'ไม่สามารถบันทึกได้!',
      text: 'จำนวนชั่วโมงมากกว่าที่ตั้งไว้',
      icon: 'error',
      confirmButtonText: 'OK'
    });

   }else {
    let ch = CheckHour(count_hour_wi,checkUnit,hour);
    if(ch == true){
      return true;
    }
    Swal.fire({
      title: 'ไม่สามารถบันทึกได้!',
      text: 'จำนวนชั่วโมงมากกว่าที่ตั้งไว้',
      icon: 'error',
      confirmButtonText: 'OK'
    });
   }

 
 

   return false
  }

  function CheckHour(count_hour,checkUnit,Hour) {
    if(Hour >= checkUnit){
const total = parseInt(count_hour) + parseInt(checkUnit)
if(Hour >= total){
  return true
}
return false
    }else {
      return false;
    } 
   }

   function Caculate() {
    const aaaa = document.getElementById("tis_compensation").value;
    const tis_quantity = document.getElementById("tis_quantity").value;

   document.getElementById("tis_sum").value = aaaa * tis_quantity;

   }

   
   function getComposetaion() {
    const teacher_id = document.getElementById("teacher_id").value
    const py = document.getElementById("pi").value
    const csrftoken = "{{ csrf_token }}";
  fetch('/api/get/compensation', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({'teacher_id':teacher_id,'py':py})
})
    .then(response => response.json())
    .then(data => {
        // Display response
        
        if(data.length == 0){
          document.getElementById("tis_compensation").value = 0
          return false;
        }
        document.getElementById("tis_compensation").value = data.compensation


    })
    .catch(error => {
        console.error('Error:', error);
      
    });
   }

  function validate(evt) {
    var theEvent = evt || window.event;

    // Handle paste
    if (theEvent.type === "paste") {
      key = event.clipboardData.getData("text/plain");
    } else {
      // Handle key press
      var key = theEvent.keyCode || theEvent.which;
      key = String.fromCharCode(key);
    }
    var regex = /[0-9]|\./;
    if (!regex.test(key)) {
      theEvent.returnValue = false;
      if (theEvent.preventDefault) theEvent.preventDefault();
    }
  }
  function sumUnit() {
    let id_tis_compensation = document.getElementById(
      "id_tis_compensation"
    ).value;
    let id_tis_quantity = document.getElementById("id_tis_quantity").value;
    if (isNaN(id_tis_compensation)) {
      d_tis_compensation = document.getElementById(
        "id_tis_compensation"
      ).value = 0;
    }

    if (isNaN(id_tis_quantity)) {
      id_tis_quantity = document.getElementById("id_tis_quantity").value = 0;
    }
    let sum = parseFloat(id_tis_compensation) * parseFloat(id_tis_quantity);
    let fix = isNaN(sum) ? 0 : sum;

    document.getElementById("id_tis_sum").value = fix.toFixed(2);
    //alert(id_tis_compensation);
  }


  function setValueDeleteModal(id) {
    document.getElementById("id_delete").value = id;
  }


  function SelectEmplo() {
  
  }
</script>
<div class="row">
  <div class="col-12 col-md-6 order-md-1 order-last">
    <h3>จัดการค่าตอบแทนครู</h3>
  </div>
  <div class="col-12 col-md-6 order-md-2 order-first">
    <nav
      aria-label="breadcrumb"
      class="breadcrumb-header float-start float-lg-end"
    >
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="/">หน้าหลัก</a>
        </li>
        <li class="breadcrumb-item">
          <a href="/finance/billing/setting">กำหนดวันอบรมและราคาอบรม</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          จัดการค่าตอบแทนครู
        </li>
      </ol>
    </nav>
  </div>
</div>

<section class="section">
  <div class="card">
    <div class="card-body">
      <div align="center">
        <h3>
          หลักสูตร <u>{{main_data.course.course_name}} </u> วันที่
          <u>{{main_data.ev_date_start}} - {{main_data.ev_date_end}} - {{main_data.ev_hour}} ชั่วโมง</u>  
        </h3>
      </div>
      <form onsubmit="return Save(event);"
        action="/course/event/teachers/form/create/{{main_data.ev_id}}"
        method="post"
        autocomplete="off"
      >
        {% csrf_token %}
        {% comment %} <div class="row">
          {% for field in form %}
          <div class="col-12 col-lg-6 col-md-6">
            {{field.label_tag }} <label style="color: red"> *</label> {{ field}}
          </div>
          {% endfor %}
        </div> {% endcomment %}
        
        <input type="hidden" class="form-control" name="count_hour_wi" id="count_hour_wi"  value="{{hour_wi}}"/>
        <input type="hidden" class="form-control" name="count_hour_pi" id="count_hour_pi"  value="{{hour_pi}}"/>
        <input type="hidden" class="form-control" name="ev_id" id="ev_id"  value="{{main_data.course_id}}"/>

        <input type="hidden" class="form-control" name="pi" id="pi"  value="1"/>
        <input type="hidden" class="form-control" name="ev_hour" id="ev_hour" value="{{main_data.ev_hour}}" />
        <div class="row">
          <div class="col-12 col-lg-6 col-md-6">
            ตำแหน่ง / หน้าที่ / รายการ: *   <label style="color: red"> *</label> 
            <select class="form-select"  id="py" name="py" onchange="handleSelectChangePy(this)">
              <option value="" disabled>
                เลือก
               </option>
              {% for listpositions in listposition %}
              <option value="{{ listpositions.id }}">
                 {{ listpositions }}
              </option>
          {% endfor %}
            </select>
        </div>
        <div class="col-12 col-lg-6 col-md-6">
          ค่าตอบแทน:   <label style="color: red"> *</label> 
          <input type="text" class="form-control" name="tis_compensation" id="tis_compensation" value="0" readonly />
    
      </div>

      <div class="col-12 col-lg-6 col-md-6">
        จำนวนต่อหน่วย *:   <label style="color: red"> *</label> 
        <select class="form-select" onchange="handleSelectChange(this)" id="tis_unit" name="tis_unit">
          <option value="hour">
             ชั่วโมง
          </option>
        </select>
    </div>

      <div class="col-12 col-lg-6 col-md-6">
        หน่วย:   <label style="color: red"> *</label> 
        <input type="text" class="form-control" name="tis_quantity" id="tis_quantity" value="1"  onkeydown="allowOnlyNumbers(event)" required />
    </div>

  <div class="col-12 col-lg-6 col-md-6">
    รวม: *   <label style="color: red"> *</label> 
    <input type="text" class="form-control" name="tis_sum" id="tis_sum" value="0"  readonly/>
</div>


<div class="col-12 col-lg-6 col-md-6">
  ครู - วิทยากร:   <label style="color: red"> *</label> 
<select class="select2" onchange="handleSelectChange(this)" id="teacher" name="teacher">
  {% for teachers in teacher %}
  <option value="">
  เลือก
 </option>
  <option value="{{ teachers.teacher_id }}">
     {{ teachers}}
  </option>
{% endfor %}
</select>
</div>  
</div>

     


   


        {% comment %} <div class="row">
          <div class="col-12 col-lg-6 col-md-6">
            ครู - วิทยากร:   <label style="color: red"> *</label> 
          <select class="select2" onchange="handleSelectChange(this)" id="teacher" name="teacher">
            {% for teachers in teacher %}
            <option value="{{ teachers.teacher_id }}">
               {{ teachers}}
            </option>
        {% endfor %}
          </select>
        </div>
        </div> {% endcomment %}
        <input type="hidden" name="teacher_id" id="teacher_id" required />
        <div style="padding-top: 25px" align="center">
          <button type="submit" class="btn btn-primary ml-1">
            <i class="bx bx-check d-block d-sm-none"></i>
            <span class="d-none d-sm-block">บันทึก</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <table class="table table-striped" id="table1">
        <thead>
          <tr>
            <th>ลำดับ</th>
            <th>ครู - วิทยากร</th>
            <th>ตำแหน่ง / หน้าที่</th>
            <th>ค่าตอบแทน</th>
            <th>จำนวนต่อหน่วย</th>
            <th>หน่วย</th>
            <th>รายได้สุทธิ</th>
            <th>#</th>
          </tr>
        </thead>
        <tbody>
          {% for res in data %}
          <tr>
            <td align="center">{{ forloop.counter }}</td>
            <td>
              {{res.teacher.teacher_prefix_th}}{{res.teacher.teacher_firstname_th}}
              {{res.teacher.teacher_lastname_th}}
            </td>
            <td>{{res.pi.pi_name}}</td>
            <td align="right">
              {{res.tis_compensation|floatformat:2|intcomma}}
            </td>
            <td align="right">{{ res.tis_quantity }}</td>
            <td align="right">{{ res.tis_unit|unit_format }}</td>
            <td align="right">{{res.tis_sum|floatformat:2|intcomma}}</td>
            <td>
              <div align="center">
                {% if res.active == 0 %}
                <button
                  type="button"
                  onclick="setValueDeleteModal('{{res.pk}}')"
                  class="btn btn-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#DeleteClick"
                >
                  <i class="icon dripicons-trash" aria-hidden="true"></i>
                  ลบ
                </button>
                {% endif %} 
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% comment %} Delete {% endcomment %}
  <div class="modal fade" id="DeleteClick">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header bg-danger">
          <h5 class="modal-title white" id="myModalLabel19">ลบ</h5>
          <button
            type="button"
            class="close"
            data-bs-dismiss="modal"
            aria-label="Close"
          >
            <i data-feather="x"></i>
          </button>
        </div>
        <form
          action="{% url 'course_teacher_event_set_income_form_delete' %}"
          method="post"
        >
          <div class="modal-body">
            {% csrf_token %}
            <input type="hidden" name="id" id="id_delete" required />
            <input
              type="hidden"
              name="ev_id"
              id="ev_id"
              required
              value="{{main_data.ev_id}}"
            />
            <div align="center">
              <h4>ยืนยันการลบข้อมูล</h4>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-light-secondary"
                data-bs-dismiss="modal"
              >
                <i class="bx bx-x d-block d-sm-none"></i>
                <span class="d-none d-sm-block">ยกเลิก</span>
              </button>
              <button type="submit" class="btn btn-primary ml-1" >
                <i class="bx bx-check d-block d-sm-none"></i>
                <span class="d-none d-sm-block">ยืนยันการลบ</span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

{% endblock %}
